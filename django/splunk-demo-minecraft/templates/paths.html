{% extends "appfx:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}{{app_label}}{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/dashboard.css" />

    <link rel="stylesheet" href="http://mc.splunk.local:81/overviewer.css" type="text/css" />

    <style>
        #overviewerFrame {
            width: 1000px;
            height: 1000px;
        }
        .splunk .container {
            width: 100%;
        }
        .container div#mcmap {
            height:1000px;
            width:100%;
        }

        /* Bootstrap Css Map Fix*/
        .container div#mcmap img { 
           max-width: none;
        }
        .container div#mcmap label { 
           width: auto; display:inline; 
        } 
        .container ul#legend {
            display: block;
            margin: auto;
            min-width: 800px;
        }

        .container ul#legend li {
            display: inline-block;
            padding: 20px;
        }

        .container ul#legend .color-block {
            display: inline-block;
            height: 50px;
            width: 50px;
            border: 1px solid black;
            border-radius: 3px;
        }
    </style>


    
{% endblock css %}

{% block content %}

    <div class="container">
        <h1>Users' paths on their last login (at most two days ago)</h1>
        <h2 id="loading">Loading...</h2>
        <div id="mcmap"></div>
        <ul id="legend"></ul>
    </div>
            

{% endblock content%}

{% block js %}   

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script>
require(['underscore', 'backbone', 'splunkjs/mvc', 'splunkjs/mvc/searchcontext'], function(_, Backbone) {
    // TODO this is bad, but what should i do?
    // the files below depend on underscore and backbone being on the root
    window._ = _;
    window.Backbone = Backbone;

    require([
        '{{STATIC_URL}}{{app_name}}/overviewerConfig.js',
        '{{STATIC_URL}}{{app_name}}/overviewer.js'
    ], function() {

        var components = require('splunkjs/mvc').Components;

        var pathSearch = components.create('appfx-searchcontext', 'users-loggin-in', {
            search: 'search sourcetype="minecraft" action=player_moved world=world | eval point=round(to_x).",".round(to_y).",".round(to_z) | table player, point',
            autostart: false,
            earliest_time: '-3w',
            latest_time: 'now',
            preview: true
        }).start();

        var datasource = pathSearch.data('preview', {
            output_mode: 'json_rows',
            count: 0 // get all results
        });

        var colors = [
            '#FF0000',
            '#00FF00',
            '#FF7F00',
            '#000000',
            '#FFFF00',
            '#FF00FF',
            '#00FFFF',
            '#BF3EFF',
            '#ADFF2F',
            '#FF69B4',
            '#7CFC00',
            '#FF00FF'
        ];

        var polylines = [];

        datasource.on('data', function(results) {
            if (!datasource.hasData()) {
                return;
            }

            $('#loading').text('');
            $('#legend').empty();

            console.log('PREVIEW RECEIVED');
            console.dir(results);

            _.each(polylines, function(polyline) {
                polyline.setMap(null);
            });
            polylines = [];

            var locations = results.collection().toJSON();
            locations = _.groupBy(locations, function(location) { return location.player; });
            var playerNames = _.keys(locations);

            _.each(playerNames, function(playerName, playerIndex) {
                var color = colors[playerIndex % colors.length];
                var points = _.pluck(locations[playerName], 'point');
                var latLngs = []

                _.each(points, function(point) {
                    var split = point.split(',');
                    var xPos = parseInt(split[0]);
                    var yPos = parseInt(split[1]);
                    var zPos = parseInt(split[2]);

                    var latLng = overviewer.util.fromWorldToLatLng(
                        xPos, yPos, zPos,
                        overviewer.mapView.options.currentTileSet
                    );

                    latLngs.push(latLng);

                });

                polylines.push(new google.maps.Polyline({
                    strokeColor: color,
                    strokeOpacity: 0.8,
                    strokeWeight: 5,
                    map: overviewer.map,
                    path: latLngs
                }));

                $('#legend').append('<li><div class="color-block" style="background-color:' + color + '"></div> ' + playerName + '</li>');


           });


        });

        overviewer.util.initialize();
        pathSearch.startSearch();

    });
});
</script>

    
{% endblock js %}

